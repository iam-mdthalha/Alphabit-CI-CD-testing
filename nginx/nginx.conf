# =============================================================================
# NGINX MAIN CONFIGURATION FILE
# =============================================================================
# This is the main Nginx configuration file. It sets global settings and
# includes site-specific configurations from the conf.d/ directory. 
#
# Location in project:   /opt/app/nginx/nginx.conf
# Location on server:   /etc/nginx/nginx.conf
# =============================================================================

# -----------------------------------------------------------------------------
# GLOBAL SETTINGS
# -----------------------------------------------------------------------------

# User that Nginx worker processes run as
# 'nginx' is created during Nginx installation
user nginx;

# Number of worker processes
# 'auto' = one worker per CPU core (recommended)
# Our t3.medium has 2 CPUs, so this will create 2 workers
worker_processes auto;

# File where Nginx stores its process ID
# Used by systemctl to manage the Nginx service
pid /run/nginx.pid;

# Error log location and level
# Levels: debug, info, notice, warn, error, crit, alert, emerg
error_log /var/log/nginx/error.log warn;

# -----------------------------------------------------------------------------
# EVENTS BLOCK
# -----------------------------------------------------------------------------
# Controls how Nginx handles connections

events {
    # Maximum simultaneous connections per worker process
    # Total max connections = worker_processes × worker_connections
    # 2 workers × 1024 = 2048 simultaneous connections
    worker_connections 1024;

    # Accept multiple connections at once (improves performance)
    multi_accept on;

    # Use the most efficient connection method for Linux
    use epoll;
}

# -----------------------------------------------------------------------------
# HTTP BLOCK
# -----------------------------------------------------------------------------
# Settings for handling HTTP/HTTPS traffic

http {
    # -------------------------------------------------------------------------
    # BASIC SETTINGS
    # -------------------------------------------------------------------------

    # Include MIME types (tells browser what type each file is)
    # Example: . html = text/html, .css = text/css, .js = application/javascript
    include /etc/nginx/mime.types;

    # Default type if file extension is not recognized
    default_type application/octet-stream;

    # Server tokens - hide Nginx version in headers (security)
    # Before:  "Server: nginx/1.24.0"
    # After:  "Server: nginx"
    server_tokens off;

    # -------------------------------------------------------------------------
    # LOGGING SETTINGS
    # -------------------------------------------------------------------------

    # Define log format
    # This creates detailed logs showing:  IP, time, request, status, etc.
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    # Where to store access logs (who visited your site)
    access_log /var/log/nginx/access.log main;

    # -------------------------------------------------------------------------
    # PERFORMANCE SETTINGS
    # -------------------------------------------------------------------------

    # sendfile - efficient file transfer
    # Instead of:  read file → copy to buffer → send to network
    # With sendfile: read file → send directly to network (faster!)
    sendfile on;

    # tcp_nopush - send headers and file together (reduces packets)
    tcp_nopush on;

    # tcp_nodelay - send small packets immediately (reduces latency)
    tcp_nodelay on;

    # How long to keep connections open
    # Higher = fewer new connections, but more memory used
    keepalive_timeout 65;

    # Maximum size of hash tables for types
    types_hash_max_size 2048;

    # -------------------------------------------------------------------------
    # GZIP COMPRESSION
    # -------------------------------------------------------------------------
    # Compresses responses to reduce bandwidth and improve load times

    # Enable gzip compression
    gzip on;

    # Minimum file size to compress (don't compress tiny files)
    gzip_min_length 1000;

    # Compression level (1-9, higher = more compression but more CPU)
    gzip_comp_level 5;

    # File types to compress
    gzip_types
        text/plain
        text/css
        text/javascript
        text/xml
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-javascript
        image/svg+xml;

    # Add "Vary: Accept-Encoding" header
    # Tells caches that content varies based on encoding support
    gzip_vary on;

    # Disable gzip for old browsers that don't support it well
    gzip_disable "msie6";

    # -------------------------------------------------------------------------
    # SSL SETTINGS (Global)
    # -------------------------------------------------------------------------
    # These apply to all HTTPS sites

    # SSL protocols - only use secure versions
    # TLSv1.0 and TLSv1.1 are considered insecure
    ssl_protocols TLSv1.2 TLSv1.3;

    # Prefer server's cipher order
    ssl_prefer_server_ciphers off;

    # SSL session caching - reuse SSL connections (faster subsequent requests)
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # -------------------------------------------------------------------------
    # SECURITY HEADERS (Global)
    # -------------------------------------------------------------------------

    # Prevent clickjacking attacks
    # SAMEORIGIN = page can only be embedded by same origin
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    # Forces browser to use declared content-type
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS filter in browsers
    add_header X-XSS-Protection "1; mode=block" always;

    # -------------------------------------------------------------------------
    # INCLUDE SITE CONFIGURATIONS
    # -------------------------------------------------------------------------
    # All . conf files in conf.d/ directory are loaded
    # This is where alphabit.conf will be loaded from

    include /etc/nginx/conf.d/*.conf;
}