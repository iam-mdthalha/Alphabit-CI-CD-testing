# =============================================================================
# NGINX CONFIGURATION FOR REACT SPA (Inside Frontend Container)
# =============================================================================
# This config is used by Nginx INSIDE the frontend Docker container. 
# It's different from /etc/nginx/conf.d/ecommerce. conf on the host. 
#
# Purpose: 
# - Serve static files (HTML, CSS, JS, images)
# - Handle React Router (SPA) routing
# - Enable gzip compression for performance
# - Set proper cache headers
#
# Location:  /etc/nginx/conf.d/default.conf (inside container)
# =============================================================================

server {
    # Listen on port 80 inside the container
    # This will be mapped to port 3000 on the host
    listen 80;
    listen [::]:80;
    
    # Server name - accept any hostname
    server_name _;
    
    # Root directory where React build files are located
    root /usr/share/nginx/html;
    
    # Default file to serve
    index index.html index.htm;

    # =========================================================================
    # GZIP COMPRESSION
    # =========================================================================
    # Compress responses to reduce bandwidth and improve load times
    
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-javascript
        image/svg+xml;

    # =========================================================================
    # MAIN LOCATION - React SPA Routing
    # =========================================================================
    # This is the most important part for React Router to work! 
    #
    # The Problem:
    # - User visits https://yoursite.com/products/123
    # - Nginx looks for a FILE called /products/123
    # - File doesn't exist â†’ 404 error
    #
    # The Solution (try_files):
    # - First, try to find the exact file ($uri)
    # - Then, try to find a directory ($uri/)
    # - If neither exists, serve index.html
    # - React Router then handles the /products/123 route client-side
    
    location / {
        try_files $uri $uri/ /index.html;
    }

    # =========================================================================
    # STATIC ASSETS - JavaScript, CSS, Images
    # =========================================================================
    # These files have content hashes in their names (e.g., main.abc123.js)
    # They can be cached forever because the hash changes when content changes
    
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # =========================================================================
    # MEDIA FILES - Images, Fonts, etc.
    # =========================================================================
    # Cache these files for a long time for performance
    
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
        access_log off;
    }

    # =========================================================================
    # SERVICE WORKER AND MANIFEST
    # =========================================================================
    # These files should not be cached (or cached briefly)
    # Service workers need to be fresh to update the app
    
    location = /service-worker.js {
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    location = /manifest. json {
        expires 1d;
        add_header Cache-Control "public, max-age=86400";
    }

    # =========================================================================
    # INDEX.HTML - Never Cache
    # =========================================================================
    # index.html should never be cached because: 
    # - It contains references to JS/CSS files with content hashes
    # - We need users to always get the latest version
    # - The browser will still cache the JS/CSS files (they have unique hashes)
    
    location = /index.html {
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }

    # =========================================================================
    # SECURITY HEADERS
    # =========================================================================
    
    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Enable XSS filter
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # =========================================================================
    # ERROR PAGES
    # =========================================================================
    # For a React SPA, most errors should show index.html
    # React Router will handle showing the appropriate error page
    
    error_page 404 /index.html;
    
    # 50x errors - server errors
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }

    # =========================================================================
    # LOGGING
    # =========================================================================
    # Access logs for debugging (can disable in production for performance)
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}