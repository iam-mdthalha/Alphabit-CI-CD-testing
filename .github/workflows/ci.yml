# =============================================================================
# ğŸŸ£ GITHUB ACTIONS CI WORKFLOW
# =============================================================================
# This workflow runs automatically when code is pushed to the repository.
# It performs:  Linting â†’ Testing â†’ Building â†’ Tester Notification
# =============================================================================

name:  CI Pipeline

# =============================================================================
# TRIGGERS:  When should this workflow run? 
# =============================================================================
on:
  # Run on push to these branches
  push:
    branches: 
      - main
      - dev
      - 'feature/*'    # Any branch starting with "feature/" like feature/login
  
  # Run on pull requests targeting these branches
  pull_request:
    branches:
      - main
      - dev

# =============================================================================
# ENVIRONMENT VARIABLES:  Shared across all jobs
# =============================================================================
env:
  NODE_VERSION: '20'                          # Node.js LTS version
  FRONTEND_DIR: 'ecommerce-frontend'          # Frontend directory name
  BACKEND_DIR: 'ecommerce-backend'            # Backend directory name
  DOCKER_REGISTRY: 'docker.io'                # Docker Hub registry
  # Image names will be:  <username>/ecommerce-frontend, <username>/ecommerce-backend

# =============================================================================
# JOBS: The actual work to be done
# =============================================================================
jobs: 

  # ===========================================================================
  # JOB 1: Lint and Test Frontend
  # ===========================================================================
  lint-and-test-frontend: 
    name: ğŸ” Lint & Test Frontend
    runs-on: ubuntu-latest
    
    # Only run if frontend files changed (saves time and resources)
    # This job ALWAYS runs on main/dev, but on feature branches only if frontend changed
    
    defaults:
      run: 
        working-directory: ${{ env.FRONTEND_DIR }}
    
    steps:
      # Step 1.1: Checkout the code from repository
      - name:  ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        # This downloads your repository code to the runner machine
      
      # Step 1.2: Setup Node.js environment
      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with: 
          node-version:  ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path:  ${{ env.FRONTEND_DIR }}/package-lock.json
        # This installs Node.js and caches npm packages for faster builds
      
      # Step 1.3: Install dependencies
      - name: ğŸ“š Install Dependencies
        run: npm ci
        # "npm ci" is faster than "npm install" for CI environments
        # It installs exact versions from package-lock.json
      
      # Step 1.4: Run TypeScript type checking
      - name: ğŸ” TypeScript Type Check
        run: npx tsc --noEmit
        # Checks for TypeScript errors without generating output files
        # --noEmit means "just check, don't create files"
      
      # Step 1.5: Run ESLint (if configured)
      - name: ğŸ§¹ Run ESLint
        run: npm run lint --if-present
        # --if-present means "run only if 'lint' script exists in package.json"
        # Won't fail if lint script doesn't exist
      
      # Step 1.6: Run tests (if configured)
      - name: ğŸ§ª Run Tests
        run: npm run test --if-present -- --passWithNoTests
        # --passWithNoTests means "don't fail if no tests exist yet"
        # This allows CI to pass even before you write tests
      
      # Step 1.7: Build the application
      - name:  ğŸ—ï¸ Build Application
        run: npm run build
        # This creates the production build
        # If build fails, there's something wrong with the code
      
      # Step 1.8: Upload build artifacts (optional, useful for debugging)
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name:  frontend-build
          path: ${{ env.FRONTEND_DIR }}/dist
          retention-days:  7
        # Saves the build output for 7 days
        # You can download it from GitHub Actions to inspect

  # ===========================================================================
  # JOB 2: Lint and Test Backend (Template - Uncomment when backend is ready)
  # ===========================================================================
  # lint-and-test-backend:
  #   name: ğŸ” Lint & Test Backend
  #   runs-on: ubuntu-latest
    
  #   # Skip this job if backend directory doesn't have package.json
  #   # Remove this condition when backend is active
  #   if: ${{ hashFiles('ecommerce-backend/package.json') != '' }}
    
  #   defaults:
  #     run:
  #       working-directory: ${{ env.BACKEND_DIR }}
    
  #   steps:
  #     - name: ğŸ“¥ Checkout Repository
  #       uses: actions/checkout@v4
      
  #     - name:  ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'
  #         cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json
      
  #     - name:  ğŸ“š Install Dependencies
  #       run: npm ci
      
  #     - name: ğŸ” TypeScript Type Check
  #       run: npx tsc --noEmit
  #       continue-on-error:  true
  #       # continue-on-error:  Backend might not have TypeScript yet
      
  #     - name: ğŸ§¹ Run ESLint
  #       run:  npm run lint --if-present
      
  #     - name:  ğŸ§ª Run Tests
  #       run: npm run test --if-present -- --passWithNoTests

  # ===========================================================================
  # JOB 3: Build Docker Images
  # ===========================================================================
  build-docker-images: 
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    
    # This job waits for lint jobs to complete successfully
    needs: [lint-and-test-frontend]
    # When backend is active, change to:  needs: [lint-and-test-frontend, lint-and-test-backend]
    
    # Define which apps to build using matrix strategy
    strategy: 
      matrix:
        include:
          - app: ecommerce-frontend
            dockerfile: ./ecommerce-frontend/Dockerfile
            context: ./ecommerce-frontend
          # Uncomment when backend is ready: 
          # - app: ecommerce-backend
          #   dockerfile: ./ecommerce-backend/Dockerfile
          #   context: ./ecommerce-backend
    
    steps: 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Setup Docker Buildx (advanced Docker builder)
      - name:  ğŸ”§ Set up Docker Buildx
        uses:  docker/setup-buildx-action@v3
        # Buildx enables advanced features like caching and multi-platform builds
      
      # Login to Docker Hub (only on push, not on pull requests)
      - name: ğŸ” Login to Docker Hub
        if: github.event_name == 'push'
        uses:  docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        # Uses secrets stored in GitHub repository settings
      
      # Generate Docker image tags
      - name:  ğŸ·ï¸ Generate Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images:  ${{ secrets.DOCKER_USERNAME }}/${{ matrix.app }}
          tags: |
            # Tag with 'latest' for main branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            # Tag with branch name
            type=ref,event=branch
            # Tag with commit SHA (first 7 characters)
            type=sha,prefix=,format=short
            # Tag with timestamp for unique identification
            type=raw,value={{date 'YYYYMMDD-HHmmss'}},enable=${{ github.ref == 'refs/heads/main' }}
      
      # Build and push Docker image
      - name: ğŸ—ï¸ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix. dockerfile }}
          push: ${{ github. event_name == 'push' && github.ref == 'refs/heads/main' }}
          # Only push to registry on push to main branch
          # Pull requests only build (don't push)
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Uses GitHub Actions cache for faster builds
      
      # Show build summary
      - name:  ğŸ“‹ Build Summary
        run:  |
          echo "### ğŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ matrix. app }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta. outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 4: Notify Tester via Email
  # ===========================================================================
  notify-tester:
    name: ğŸ“§ Notify Tester
    runs-on: ubuntu-latest
    
    # Run after Docker build completes
    needs:  [build-docker-images]
    
    # Only notify on push to main, dev, or feature branches (not on PRs)
    if: github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Get commit information for the email
      - name:  ğŸ“ Get Commit Info
        id: commit_info
        run:  |
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      # Send email notification
      - name: ğŸ“§ Send Email Notification
        uses:  dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets. SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: |
            [CI] âœ… New code pushed to ${{ github.ref_name }} - ${{ github.repository }}
          to: ${{ secrets.TESTER_EMAIL }}
          from: CI Bot <${{ secrets.SMTP_USERNAME }}>
          body: |
            Hello Tester,
            
            New code has been pushed and CI pipeline completed successfully.
            
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“‹ PUSH DETAILS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ğŸ”¹ Repository: ${{ github.repository }}
            ğŸ”¹ Branch:  ${{ github.ref_name }}
            ğŸ”¹ Commit: ${{ steps.commit_info.outputs.sha_short }}
            ğŸ”¹ Author: ${{ steps.commit_info.outputs.author }}
            ğŸ”¹ Message: ${{ steps.commit_info.outputs.message }}
            
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ”— LINKS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ğŸ“‚ View Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
            ğŸ”„ View Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            Please review and test the changes. 
            
            Regards,
            CI Bot ğŸ¤–
          
          # HTML version of the email (optional - some email clients prefer HTML)
          html_body: |
            <html>
            <body style="font-family:  Arial, sans-serif; line-height: 1.6; color: #333;">
              <h2 style="color: #28a745;">âœ… CI Pipeline Successful</h2>
              
              <table style="border-collapse: collapse; width:  100%; max-width: 600px;">
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd; background:  #f9f9f9;"><strong>Repository</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.repository }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><strong>Branch</strong></td>
                  <td style="padding: 8px; border:  1px solid #ddd;">${{ github.ref_name }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><strong>Commit</strong></td>
                  <td style="padding:  8px; border: 1px solid #ddd;">${{ steps.commit_info.outputs.sha_short }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border:  1px solid #ddd; background:  #f9f9f9;"><strong>Author</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ steps.commit_info.outputs. author }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><strong>Message</strong></td>
                  <td style="padding:  8px; border: 1px solid #ddd;">${{ steps.commit_info.outputs.message }}</td>
                </tr>
              </table>
              
              <p style="margin-top: 20px;">
                <a href="${{ github. server_url }}/${{ github.repository }}/commit/${{ github.sha }}" 
                   style="background:  #0366d6; color:  white; padding: 10px 20px; text-decoration:  none; border-radius: 5px;">
                  View Commit
                </a>
                <a href="${{ github. server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                   style="background: #28a745; color:  white; padding: 10px 20px; text-decoration:  none; border-radius: 5px; margin-left: 10px;">
                  View Workflow
                </a>
              </p>
              
              <p style="color: #666; margin-top: 30px;">Please review and test the changes.</p>
              
              <hr style="border: none; border-top:  1px solid #ddd; margin:  20px 0;">
              <p style="color: #999; font-size: 12px;">CI Bot ğŸ¤– - Automated notification</p>
            </body>
            </html>

  # ===========================================================================
  # JOB 5: CI Summary (Final Status)
  # ===========================================================================
  ci-summary:
    name: ğŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-test-frontend, build-docker-images]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate CI Summary
        run: |
          echo "## ğŸ¯ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Test Frontend | ${{ needs.lint-and-test-frontend.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker Images | ${{ needs. build-docker-images.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github. ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY