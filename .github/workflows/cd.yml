# =============================================================================
# ðŸŸ¡ GITHUB ACTIONS CD WORKFLOW (Continuous Deployment)
# =============================================================================

name: CD Pipeline

# =============================================================================
# TRIGGERS
# =============================================================================
on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# =============================================================================
# GLOBAL ENV
# =============================================================================
env:
  NODE_VERSION: '20'
  FRONTEND_DIR: 'ecommerce-frontend'
  DEPLOY_PATH: '/opt/app'

# =============================================================================
# JOBS
# =============================================================================
jobs:

# =============================================================================
# JOB 1: BUILD & PUSH
# =============================================================================
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ github.run_number }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ·ï¸ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend
          tags: |
            type=raw,value=latest
            type=raw,value=${{ github.run_number }}

      - name: ðŸ—ï¸ Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.FRONTEND_DIR }}
          file: ./${{ env.FRONTEND_DIR }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CI=false
            REACT_APP_ENV=production

# =============================================================================
# JOB 2: DEPLOY
# =============================================================================
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ðŸ”‘ Setup SSH
        shell: bash
        run: |
          mkdir -p "$HOME/.ssh"
          echo "${{ secrets.EC2_SSH_KEY }}" > "$HOME/.ssh/deploy_key"
          chmod 400 "$HOME/.ssh/deploy_key"
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true

      - name: ðŸš€ Deploy Application
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          ssh -i "$HOME/.ssh/deploy_key" -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            "$EC2_USER@$EC2_HOST" \
            "DEPLOY_PATH='${DEPLOY_PATH}' DOCKER_USERNAME='${DOCKER_USERNAME}' DOCKER_PASSWORD='${DOCKER_PASSWORD}' bash -s" << 'ENDSSH'
              set -e

              echo "=========================================="
              echo "ðŸš€ Deployment started"
              echo "=========================================="

              sudo mkdir -p "$DEPLOY_PATH"
              sudo chown "$USER:$USER" "$DEPLOY_PATH"
              cd "$DEPLOY_PATH"

              echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

              echo "ðŸ“¥ Pulling latest image..."
              docker pull "$DOCKER_USERNAME/ecommerce-frontend:latest"

              if [ -f docker-compose.yml ]; then
                echo "ðŸ“„ Using docker-compose..."
                docker compose down --remove-orphans || true
                docker rm -f ecommerce-frontend 2>/dev/null || true
                docker compose up -d
              else
                echo "ðŸ³ Running standalone container..."
                docker stop ecommerce-frontend 2>/dev/null || true
                docker rm ecommerce-frontend 2>/dev/null || true

                docker run -d \
                  --name ecommerce-frontend \
                  --restart unless-stopped \
                  -p 3000:80 \
                  "$DOCKER_USERNAME/ecommerce-frontend:latest"
              fi

              docker image prune -f

              echo "=========================================="
              echo "âœ… Deployment complete"
              echo "=========================================="
          ENDSSH

# =============================================================================
# JOB 3: HEALTH CHECK
# =============================================================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: â³ Wait for App
        run: sleep 20

      - name: ðŸ¥ Check Health
        run: |
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 --max-time 30 \
              "http://${{ secrets.EC2_HOST }}" || echo "000")

            echo "Attempt $i â†’ HTTP $STATUS"

            if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
              echo "âœ… Application is healthy"
              exit 0
            fi

            sleep 10
          done

          echo "âŒ Health check failed"
          exit 1

# =============================================================================
# JOB 4: ROLLBACK
# =============================================================================
  rollback:
    name: ðŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: health-check
    if: failure()

    steps:
      - name: ðŸ”‘ Setup SSH
        shell: bash
        run: |
          mkdir -p "$HOME/.ssh"
          echo "${{ secrets.EC2_SSH_KEY }}" > "$HOME/.ssh/deploy_key"
          chmod 400 "$HOME/.ssh/deploy_key"
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true

      - name: ðŸ”„ Rollback Deployment
        run: |
          ssh -i "$HOME/.ssh/deploy_key" -o StrictHostKeyChecking=no \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'ENDSSH'
              set -e

              PREV_TAG=$(( ${{ github.run_number }} - 1 ))

              docker stop ecommerce-frontend 2>/dev/null || true
              docker rm ecommerce-frontend 2>/dev/null || true

              docker pull "${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:$PREV_TAG"

              docker run -d \
                --name ecommerce-frontend \
                --restart unless-stopped \
                -p 3000:80 \
                "${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:$PREV_TAG"

              echo "ðŸ”„ Rollback completed"
          ENDSSH
