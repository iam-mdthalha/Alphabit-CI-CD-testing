# =============================================================================
# ðŸŸ¡ GITHUB ACTIONS CD WORKFLOW (Continuous Deployment)
# =============================================================================

name: CD Pipeline

# =============================================================================
# TRIGGERS
# =============================================================================
on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# =============================================================================
# GLOBAL ENV
# =============================================================================
env:
  NODE_VERSION: '20'
  FRONTEND_DIR: 'ecommerce-frontend'
  BACKEND_DIR: 'ecommerce-backend'
  DEPLOY_PATH: '/opt/app'
  DOCKER_REGISTRY: 'docker.io'

# =============================================================================
# JOBS
# =============================================================================
jobs:

# =============================================================================
# JOB 1: BUILD & PUSH
# =============================================================================
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ·ï¸ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend
          tags: |
            type=raw,value=latest
            type=sha,format=short
            type=raw,value=${{ github.run_number }}

      - name: ðŸ—ï¸ Build & Push Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.FRONTEND_DIR }}
          file: ./${{ env.FRONTEND_DIR }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CI=false
            REACT_APP_ENV=production

# =============================================================================
# JOB 2: DEPLOY
# =============================================================================
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 400 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy Application
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST \
          "DEPLOY_PATH='${DEPLOY_PATH}' bash -s" << 'EOF'
            set -e

            echo "ðŸš€ Deployment started"

            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            docker login -u "${{ secrets.DOCKER_USERNAME }}" \
              -p "${{ secrets.DOCKER_PASSWORD }}"

            docker pull ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:latest

            if [ -f docker-compose.yml ]; then
              docker compose down || true
              docker compose up -d
            else
              docker stop ecommerce-frontend || true
              docker rm ecommerce-frontend || true

              docker run -d \
                --name ecommerce-frontend \
                --restart unless-stopped \
                -p 3000:80 \
                ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:latest
            fi

            docker image prune -f
            echo "âœ… Deployment complete"
          EOF

# =============================================================================
# JOB 3: HEALTH CHECK
# =============================================================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: â³ Wait for App
        run: sleep 15

      - name: ðŸ¥ Check Health
        run: |
          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              http://${{ secrets.EC2_HOST }}:3000 || echo 000)

            echo "Attempt $i â†’ $STATUS"

            if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ]; then
              echo "âœ… App is healthy"
              exit 0
            fi

            sleep 10
          done

          echo "âŒ Health check failed"
          exit 1

# =============================================================================
# JOB 4: ROLLBACK
# =============================================================================
  rollback:
    name: ðŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: health-check
    if: failure()

    steps:
      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 400 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ”„ Rollback Deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            PREVIOUS_TAG=$(( ${{ github.run_number }} - 1 ))

            docker stop ecommerce-frontend || true
            docker rm ecommerce-frontend || true

            docker run -d \
              --name ecommerce-frontend \
              --restart unless-stopped \
              -p 3000:80 \
              ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:$PREVIOUS_TAG

            echo "ðŸ”„ Rollback completed"
          EOF

# =============================================================================
# JOB 5: NOTIFICATION
# =============================================================================
  notify:
    name: ðŸ“§ Notify Team
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy, health-check]
    if: always()

    steps:
      - name: ðŸ“§ Send Status Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[CD] Deployment Status - ${{ github.repository }}"
          to: ${{ secrets.TESTER_EMAIL }}
          from: "CD Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Build: ${{ needs.build-and-push.result }}
            Deploy: ${{ needs.deploy.result }}
            Health: ${{ needs.health-check.result }}

            Workflow:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
