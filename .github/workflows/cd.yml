# =============================================================================
# üü° GITHUB ACTIONS CD WORKFLOW (Continuous Deployment)
# =============================================================================

name:  CD Pipeline

# =============================================================================
# TRIGGERS
# =============================================================================
on:
  push: 
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default:  'production'
        type:  choice
        options:
          - production
          - staging

# =============================================================================
# GLOBAL ENV
# =============================================================================
env: 
  NODE_VERSION: '20'
  FRONTEND_DIR: 'ecommerce-frontend'
  BACKEND_DIR: 'ecommerce-backend'
  DEPLOY_PATH: '/opt/app'
  DOCKER_REGISTRY: 'docker.io'

# =============================================================================
# JOBS
# =============================================================================
jobs:

  # ===========================================================================
  # JOB 1: BUILD & PUSH
  # ===========================================================================
  build-and-push:
    name:  üê≥ Build & Push Docker Image
    runs-on:  ubuntu-latest

    outputs: 
      image_digest: ${{ steps.build.outputs.digest }}
      image_tag: ${{ github.run_number }}

    steps: 
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üè∑Ô∏è Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with: 
          images: ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend
          tags: |
            type=raw,value=latest
            type=sha,format=short
            type=raw,value=${{ github.run_number }}

      - name: üèóÔ∏è Build & Push Image
        id: build
        uses:  docker/build-push-action@v5
        with:
          context: ./${{ env. FRONTEND_DIR }}
          file: ./${{ env.FRONTEND_DIR }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps. meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CI=false
            REACT_APP_ENV=production

      - name: üìã Build Summary
        run: |
          echo "### üê≥ Docker Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 2: DEPLOY
  # ===========================================================================
  deploy:
    name: üöÄ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'

    steps:
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 400 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: üöÄ Deploy Application
        env: 
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            $EC2_USER@$EC2_HOST << ENDSSH
            set -e

            echo "=========================================="
            echo "üöÄ Deployment started"
            echo "=========================================="

            # Create deploy directory if not exists
            sudo mkdir -p $DEPLOY_PATH
            sudo chown \$USER:\$USER $DEPLOY_PATH
            cd $DEPLOY_PATH

            # Login to Docker Hub
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

            # Pull latest image
            echo "üì• Pulling latest image..."
            docker pull $DOCKER_USERNAME/ecommerce-frontend:latest

            # Deploy using docker-compose or standalone
            if [ -f docker-compose.yml ]; then
              echo "üìÑ Using docker-compose..."
              docker compose down --remove-orphans || true
              docker compose up -d
            else
              echo "üê≥ Running standalone container..."
              docker stop ecommerce-frontend 2>/dev/null || true
              docker rm ecommerce-frontend 2>/dev/null || true

              docker run -d \
                --name ecommerce-frontend \
                --restart unless-stopped \
                -p 3000:80 \
                $DOCKER_USERNAME/ecommerce-frontend:latest
            fi

            # Cleanup old images
            docker image prune -f

            echo "=========================================="
            echo "‚úÖ Deployment complete"
            echo "=========================================="
          ENDSSH

      - name: üìã Deploy Summary
        run: |
          echo "### üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 3: HEALTH CHECK
  # ===========================================================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.result == 'success'

    outputs:
      status: ${{ steps.check.outputs.status }}

    steps:
      - name:  ‚è≥ Wait for App to Start
        run: sleep 20

      - name: üè• Check Health
        id: check
        run: |
          echo "Checking application health..."
          
          for i in 1 2 3 4 5; do
            echo "Attempt $i of 5..."
            
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 --max-time 30 \
              "http://${{ secrets.EC2_HOST }}:3000" || echo "000")

            echo "HTTP Status: $STATUS"

            if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
              echo "‚úÖ Application is healthy!"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ $i -lt 5 ]; then
              echo "Waiting 10 seconds before retry..."
              sleep 10
            fi
          done

          echo "‚ùå Health check failed after 5 attempts"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          exit 1

      - name: üìã Health Summary
        if: always()
        run: |
          echo "### üè• Health Check" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.status }}" = "healthy" ]; then
            echo "‚úÖ **Status:** Healthy" >> $GITHUB_STEP_SUMMARY
            echo "üåê **URL:** http://${{ secrets.EC2_HOST }}:3000" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # JOB 4: ROLLBACK (Only if health check fails)
  # ===========================================================================
  rollback:
    name: üîÑ Rollback
    runs-on:  ubuntu-latest
    needs: health-check
    if: failure()

    steps:
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 400 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: üîÑ Rollback Deployment
        env:
          EC2_HOST:  ${{ secrets.EC2_HOST }}
          EC2_USER:  ${{ secrets.EC2_USER }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          PREVIOUS_TAG: ${{ github.run_number-1 }}
        run:  |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            $EC2_USER@$EC2_HOST << ENDSSH
            set -e

            echo "=========================================="
            echo "üîÑ Starting Rollback"
            echo "=========================================="

            # Calculate previous tag
            PREV_TAG=\$(( ${{ github.run_number }} - 1 ))
            echo "Rolling back to tag: \$PREV_TAG"

            # Stop current container
            docker stop ecommerce-frontend 2>/dev/null || true
            docker rm ecommerce-frontend 2>/dev/null || true

            # Try to run previous version
            if docker pull $DOCKER_USERNAME/ecommerce-frontend:\$PREV_TAG 2>/dev/null; then
              docker run -d \
                --name ecommerce-frontend \
                --restart unless-stopped \
                -p 3000:80 \
                $DOCKER_USERNAME/ecommerce-frontend:\$PREV_TAG
              echo "‚úÖ Rolled back to version \$PREV_TAG"
            else
              echo "‚ö†Ô∏è Previous version not found, keeping current state"
            fi

            echo "=========================================="
            echo "üîÑ Rollback Complete"
            echo "=========================================="
          ENDSSH

      - name: üìã Rollback Summary
        run: |
          echo "### üîÑ Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Health check failed" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 5: NOTIFICATION
  # ===========================================================================
  notify:
    name: üìß Notify Team
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy, health-check]
    if: always()

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name:  üìù Get Commit Info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: üìß Send Status Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address:  ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[CD] ${{ needs.health-check.result == 'success' && '‚úÖ Deployed' || '‚ùå Failed' }} - ${{ github.repository }}"
          to: ${{ secrets.TESTER_EMAIL }}
          from: "CD Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Deployment Status Report
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            üì¶ Repository: ${{ github.repository }}
            üåø Branch: ${{ github.ref_name }}
            üìù Commit: ${{ steps.commit.outputs.sha }}
            üë§ Author: ${{ steps.commit.outputs.author }}
            üí¨ Message: ${{ steps.commit.outputs.message }}

            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            Pipeline Results:
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            üê≥ Build: ${{ needs.build-and-push.result }}
            üöÄ Deploy: ${{ needs.deploy.result }}
            üè• Health: ${{ needs.health-check.result }}

            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            üîó Workflow:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            üåê Application: http://${{ secrets.EC2_HOST }}:3000

            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            CD Bot ü§ñ
        continue-on-error: true

      - name: üìä Final Summary
        if: always()
        run: |
          echo "## üìä CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üê≥ Build & Push | ${{ needs.build-and-push.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Deploy | ${{ needs.deploy.result == 'success' && '‚úÖ' || needs.deploy.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üè• Health Check | ${{ needs.health-check.result == 'success' && '‚úÖ' || needs.health-check.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY