# =============================================================================
# ğŸŸ¡ GITHUB ACTIONS CD WORKFLOW (Continuous Deployment)
# =============================================================================
# This workflow automatically deploys the application to EC2 when code is 
# pushed to the main branch.  It builds Docker images, pushes to Docker Hub,
# and updates the running containers on the server.
# =============================================================================

name: CD Pipeline

# =============================================================================
# TRIGGERS:  Only deploy on push to main branch
# =============================================================================
on:
  push: 
    branches: 
      - main
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch: 
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options: 
          - production
          - staging

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
env: 
  NODE_VERSION: '20'
  FRONTEND_DIR: 'ecommerce-frontend'
  BACKEND_DIR: 'ecommerce-backend'
  DEPLOY_PATH: '/opt/app'
  DOCKER_REGISTRY: 'docker.io'

# =============================================================================
# JOBS
# =============================================================================
jobs: 

  # ===========================================================================
  # JOB 1: Build and Push Docker Images
  # ===========================================================================
  build-and-push: 
    name: ğŸ³ Build & Push Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Generate Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend
          tags: |
            type=raw,value=latest
            type=sha,prefix=,format=short
            type=raw,value=${{ github.run_number }}

      - name: ğŸ—ï¸ Build and Push Docker Image
        id: build
        uses:  docker/build-push-action@v5
        with:
          context: ./${{ env.FRONTEND_DIR }}
          file: . /${{ env.FRONTEND_DIR }}/Dockerfile
          push:  true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CI=false
            REACT_APP_ENV=production

      - name: ğŸ“‹ Build Summary
        run: |
          echo "### ğŸ³ Docker Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 2: Deploy to EC2 Server
  # ===========================================================================
  deploy: 
    name: ğŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: [build-and-push]
    
    # Only deploy if build was successful
    if: needs.build-and-push.result == 'success'

    steps:
      - name:  ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ğŸš€ Deploy to EC2
        env:
          EC2_HOST:  ${{ secrets.EC2_HOST }}
          EC2_USER:  ${{ secrets.EC2_USER }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "ğŸš€ Starting Deployment"
            echo "=========================================="
            
            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }} || {
              echo "âŒ Deployment directory not found:  ${{ env.DEPLOY_PATH }}"
              echo "Creating deployment directory..."
              sudo mkdir -p ${{ env.DEPLOY_PATH }}
              sudo chown $USER:$USER ${{ env.DEPLOY_PATH }}
              cd ${{ env.DEPLOY_PATH }}
            }
            
            echo "ğŸ“‚ Current directory: $(pwd)"
            
            # Login to Docker Hub
            echo "ğŸ” Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            # Pull the latest image
            echo "ğŸ“¥ Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:latest
            
            # Check if docker-compose.yml exists
            if [ -f "docker-compose.yml" ]; then
              echo "ğŸ“„ Found docker-compose.yml"
              
              # Stop existing containers gracefully
              echo "ğŸ›‘ Stopping existing containers..."
              docker compose down --remove-orphans || true
              
              # Start new containers
              echo "ğŸš€ Starting new containers..."
              docker compose up -d
              
              # Wait for containers to be healthy
              echo "â³ Waiting for containers to start..."
              sleep 10
              
              # Show container status
              echo "ğŸ“Š Container Status:"
              docker compose ps
            else
              echo "âš ï¸ docker-compose.yml not found, running standalone container..."
              
              # Stop existing container if running
              docker stop ecommerce-frontend 2>/dev/null || true
              docker rm ecommerce-frontend 2>/dev/null || true
              
              # Run new container
              docker run -d \
                --name ecommerce-frontend \
                --restart unless-stopped \
                -p 3000:80 \
                ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:latest
              
              sleep 10
            fi
            
            # Clean up old images to save disk space
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            
            echo "=========================================="
            echo "âœ… Deployment Complete!"
            echo "=========================================="
          ENDSSH

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "### ğŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend: latest" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 3: Health Check
  # ===========================================================================
  health-check:
    name:  ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    
    if: needs.deploy.result == 'success'

    steps: 
      - name: â³ Wait for Application to Start
        run: sleep 15

      - name: ğŸ¥ Check Application Health
        id: health
        run: |
          echo "Checking health of deployed application..."
          
          # Try to reach the application
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            # Check if the application responds
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "http://${{ secrets.EC2_HOST }}:3000" || echo "000")
            
            echo "HTTP Status: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
              echo "âœ… Application is healthy!"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          echo "âŒ Application health check failed after $MAX_RETRIES attempts"
          echo "health_status=unhealthy" >> $GITHUB_OUTPUT
          exit 1
        continue-on-error: true

      - name: ğŸ“‹ Health Check Summary
        run: |
          echo "### ğŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.health.outputs.health_status }}" = "healthy" ]; then
            echo "âœ… **Status:** Healthy" >> $GITHUB_STEP_SUMMARY
            echo "ğŸŒ **URL:** http://${{ secrets.EC2_HOST }}: 3000" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Unhealthy - Manual intervention may be required" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # JOB 4: Rollback (Only runs if health check fails)
  # ===========================================================================
  rollback: 
    name: ğŸ”„ Rollback Deployment
    runs-on: ubuntu-latest
    needs: [health-check]
    
    # Only run if health check failed
    if: needs.health-check.result == 'failure'

    steps: 
      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ğŸ”„ Rollback to Previous Version
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "ğŸ”„ Starting Rollback"
            echo "=========================================="
            
            cd ${{ env.DEPLOY_PATH }} || exit 1
            
            # Get the previous image
            PREVIOUS_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "ecommerce-frontend" | head -2 | tail -1)
            
            if [ -n "$PREVIOUS_IMAGE" ]; then
              echo "Rolling back to:  $PREVIOUS_IMAGE"
              
              # Stop current containers
              docker compose down || docker stop ecommerce-frontend || true
              
              # Start with previous image (if using docker-compose, you'd update the image tag)
              docker run -d \
                --name ecommerce-frontend \
                --restart unless-stopped \
                -p 3000:80 \
                $PREVIOUS_IMAGE
              
              echo "âœ… Rollback complete!"
            else
              echo "âŒ No previous image found for rollback"
              echo "Manual intervention required"
              exit 1
            fi
            
            echo "=========================================="
            echo "ğŸ”„ Rollback Complete"
            echo "=========================================="
          ENDSSH

      - name: ğŸ“‹ Rollback Summary
        run: |
          echo "### ğŸ”„ Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Reason:** Health check failed after deployment" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”™ **Action:** Rolled back to previous version" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“§ **Next Steps:** Check logs and investigate the issue" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 5: Notify Team (Optional - runs on success or failure)
  # ===========================================================================
  notify:
    name:  ğŸ“§ Send Notification
    runs-on:  ubuntu-latest
    needs: [build-and-push, deploy, health-check]
    
    # Always run this job to send notification
    if: always()

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses:  actions/checkout@v4

      - name: ğŸ“ Get Commit Info
        id: commit_info
        run: |
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: ğŸ“§ Send Success Notification
        if: needs.health-check.result == 'success'
        uses: dawidd6/action-send-mail@v3
        with: 
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[CD] âœ… Deployment Successful - ${{ github.repository }}"
          to: ${{ secrets.TESTER_EMAIL }}
          from:  "CD Bot <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Hello Team,

            ğŸ‰ Deployment completed successfully!

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“‹ DEPLOYMENT DETAILS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸ”¹ Repository: ${{ github.repository }}
            ğŸ”¹ Branch: ${{ github.ref_name }}
            ğŸ”¹ Commit: ${{ steps.commit_info.outputs.sha_short }}
            ğŸ”¹ Author: ${{ steps.commit_info.outputs.author }}
            ğŸ”¹ Message: ${{ steps.commit_info.outputs.message }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸŒ APPLICATION URLS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸ”¹ Application: http://${{ secrets.EC2_HOST }}:3000
            ğŸ”¹ Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            The application is now live and healthy. 

            Regards,
            CD Bot ğŸ¤–
        continue-on-error: true

      - name: ğŸ“§ Send Failure Notification
        if: needs.health-check. result == 'failure' || needs.deploy.result == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username:  ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[CD] âŒ Deployment Failed - ${{ github.repository }}"
          to: ${{ secrets.TESTER_EMAIL }}
          from: "CD Bot <${{ secrets.SMTP_USERNAME }}>"
          body:  |
            âš ï¸ ALERT: Deployment Failed! 

            Hello Team,

            The deployment has failed and may require manual intervention.

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“‹ FAILURE DETAILS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸ”¹ Repository: ${{ github.repository }}
            ğŸ”¹ Branch: ${{ github.ref_name }}
            ğŸ”¹ Commit:  ${{ steps.commit_info.outputs.sha_short }}
            ğŸ”¹ Author: ${{ steps.commit_info.outputs.author }}
            ğŸ”¹ Build Status: ${{ needs.build-and-push.result }}
            ğŸ”¹ Deploy Status: ${{ needs.deploy.result }}
            ğŸ”¹ Health Status: ${{ needs.health-check.result }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ”— INVESTIGATION LINKS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸ”¹ Workflow Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Please investigate and take necessary action.

            Regards,
            CD Bot ğŸ¤–
        continue-on-error: true

      - name: ğŸ“‹ Final Summary
        if: always()
        run: |
          echo "## ğŸ“Š CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Push | ${{ needs.build-and-push.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ… Success' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result == 'success' && 'âœ… Healthy' || needs.health-check.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY